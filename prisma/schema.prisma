// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "sqlite"
}

model Material {
  id          String   @id @default(cuid())
  name        String
  type        String   // e.g., "Steel", "Aluminum"
  thickness   Float    // in mm
  width       Float    // in mm
  length      Float    // in mm
  minStock    Int      @default(10)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchaseItems OrderItem[]
  jobConsumptions JobConsumption[]
  stockMovements StockMovement[]
  bomItems      BOMItem[]
  stocks        Stock[]
}

model Warehouse {
  id          String   @id @default(cuid())
  name        String
  address     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stocks      Stock[]
  movements   StockMovement[]
  shipmentItems ShipmentItem[]
}

model Stock {
  id          String   @id @default(cuid())
  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  
  materialId  String?
  material    Material? @relation(fields: [materialId], references: [id])
  
  productId   String?
  product     Product?  @relation(fields: [productId], references: [id])

  quantity    Int      @default(0)
  
  // Optional: Lot/Serial tracking
  lotNumber   String?
  serialNumber String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([warehouseId, materialId, lotNumber, serialNumber])
  @@unique([warehouseId, productId, lotNumber, serialNumber])
}

model StockMovement {
  id          String   @id @default(cuid())
  
  materialId  String?
  material    Material? @relation(fields: [materialId], references: [id])
  
  productId   String?
  product     Product?  @relation(fields: [productId], references: [id])

  warehouseId String?   // Optional for legacy data, but should be required moving forward
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id])

  type        String   // "IN", "OUT", "ADJUSTMENT", "TRANSFER"
  quantity    Int
  reason      String?
  
  lotNumber   String?
  serialNumber String?

  createdAt   DateTime @default(now())
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Float?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  saleItems   OrderItem[]
  producedIn  ProductionJob[]
  quoteItems  QuoteItem[]
  boms        BillOfMaterial[]
  routings    Routing[]
  stocks      Stock[]
  stockMovements StockMovement[]
  shipmentItems ShipmentItem[]
}

model Routing {
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  productId   String
  product     Product  @relation(fields: [productId], references: [id])

  steps       RoutingStep[]
}

model RoutingStep {
  id          String   @id @default(cuid())
  routingId   String
  routing     Routing  @relation(fields: [routingId], references: [id])
  
  order       Int
  type        String   // CUT, BEND, WELD, PAINT, ASSEMBLY, etc.
  description String?
}

model BillOfMaterial {
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  productId   String
  product     Product  @relation(fields: [productId], references: [id])

  items       BOMItem[]
}

model BOMItem {
  id          String         @id @default(cuid())
  bomId       String
  bom         BillOfMaterial @relation(fields: [bomId], references: [id])
  
  materialId  String
  material    Material       @relation(fields: [materialId], references: [id])

  quantity    Float          // Quantity needed per 1 unit of product
}

model ThirdParty {
  id          String   @id @default(cuid())
  name        String
  email       String?
  phone       String?
  address     String?
  taxId       String?
  
  isCustomer  Boolean  @default(false)
  isSupplier  Boolean  @default(false)
  isProspect  Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  contacts    Contact[]
  orders      Order[]
  quotes      Quote[]
  invoices    Invoice[]
  shipments   Shipment[]
}

model Contact {
  id           String     @id @default(uuid())
  thirdPartyId String
  thirdParty   ThirdParty @relation(fields: [thirdPartyId], references: [id])
  
  firstName    String
  lastName     String
  email        String?
  phone        String?
  role         String?    // e.g. CEO, Sales Rep
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Invoice {
  id           String        @id @default(uuid())
  type         String        // SALES or PURCHASE
  thirdPartyId String
  thirdParty   ThirdParty    @relation(fields: [thirdPartyId], references: [id])
  orderId      String?
  status       String        @default("DRAFT") // DRAFT, VALIDATED, PAID, CANCELLED, PARTIALLY_PAID
  issueDate    DateTime      @default(now())
  dueDate      DateTime?
  totalAmount  Float
  paidAmount   Float         @default(0)
  items        InvoiceItem[]
  payments     Payment[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

model InvoiceItem {
  id          String  @id @default(uuid())
  invoiceId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  description String
  quantity    Int
  unitPrice   Float
  totalPrice  Float
}

model Payment {
  id        String   @id @default(uuid())
  invoiceId String
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])
  amount    Float
  date      DateTime @default(now())
  method    String   // CASH, BANK_TRANSFER, CHECK, CREDIT_CARD
  reference String?
  createdAt DateTime @default(now())
}

model Quote {
  id          String      @id @default(cuid())
  status      String      @default("DRAFT") // DRAFT, VALIDATED, SIGNED, REFUSED
  totalAmount Float       @default(0)
  validUntil  DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  thirdPartyId String
  thirdParty   ThirdParty @relation(fields: [thirdPartyId], references: [id])

  items       QuoteItem[]
}

model QuoteItem {
  id          String   @id @default(cuid())
  quoteId     String
  quote       Quote    @relation(fields: [quoteId], references: [id])
  
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])

  quantity    Int
  unitPrice   Float
}

model Order {
  id          String      @id @default(cuid())
  type        String      // "PURCHASE", "SALE"
  status      String      @default("PENDING") // PENDING, COMPLETED, CANCELLED
  totalAmount Float       @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  thirdPartyId String?
  thirdParty   ThirdParty? @relation(fields: [thirdPartyId], references: [id])

  items       OrderItem[]
  shipments   Shipment[]
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  
  materialId  String?
  material    Material? @relation(fields: [materialId], references: [id])

  productId   String?
  product     Product?  @relation(fields: [productId], references: [id])

  quantity    Int
  unitPrice   Float
}

model Shipment {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  
  thirdPartyId String
  thirdParty   ThirdParty @relation(fields: [thirdPartyId], references: [id])

  status      String   @default("DRAFT") // DRAFT, SHIPPED, DELIVERED
  trackingNumber String?
  date        DateTime @default(now())
  
  items       ShipmentItem[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ShipmentItem {
  id          String   @id @default(cuid())
  shipmentId  String
  shipment    Shipment @relation(fields: [shipmentId], references: [id])
  
  productId   String?
  product     Product? @relation(fields: [productId], references: [id])
  
  quantity    Int

  warehouseId String?
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id])
  
  lotNumber   String?
  serialNumber String?
}

model ProductionJob {
  id          String   @id @default(cuid())
  status      String   @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  quantity    Int

  operations  JobOperation[]
  consumptions JobConsumption[]
}

model JobOperation {
  id          String   @id @default(cuid())
  jobId       String
  job         ProductionJob @relation(fields: [jobId], references: [id])
  type        String   // "CUT", "BEND", "WELD"
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED
  notes       String?
  order       Int      // Sequence order
}

model JobConsumption {
  id          String   @id @default(cuid())
  jobId       String
  job         ProductionJob @relation(fields: [jobId], references: [id])
  materialId  String
  material    Material @relation(fields: [materialId], references: [id])
  quantity    Int      // How many sheets used
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("USER") // ADMIN, USER
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
